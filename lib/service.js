"use strict";var __awaiter=this&&this.__awaiter||function(e,a,c,i){return new(c=c||Promise)(function(n,t){function r(e){try{s(i.next(e))}catch(e){t(e)}}function o(e){try{s(i.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?n(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(r,o)}s((i=i.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(n,r){var o,s,a,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,s&&(a=2&t[0]?s.return:t[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,t[1])).done)return a;switch(s=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,s=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){c.label=t[1];break}if(6===t[0]&&c.label<a[1]){c.label=a[1],a=t;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(t);break}a[2]&&c.ops.pop(),c.trys.pop();continue}t=r.call(n,c)}catch(e){t=[6,e],s=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var seroWallet_1=require("./wallet/seroWallet"),ethWallet_1=require("./wallet/ethWallet"),types_1=require("./types"),collection_1=require("./collection"),superzk=require("jsuperzk/dist/protocol/account"),wallet_1=require("jsuperzk/dist/wallet/wallet"),ethereumjs_wallet_1=require("ethereumjs-wallet"),utils_1=require("jsuperzk/dist/utils/utils"),uuidv4=require("uuid/v4"),randomBytes=require("randombytes"),Service=function(){function e(){var t=this;this.execute=function(e){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(e){return[2]})})}}return e.prototype.generateMnemonic=function(){return(new seroWallet_1.SeroWallet).generateMnemonic()},e.prototype.exportMnemonic=function(n,r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.keyStoreCollection.find({accountId:n,chainType:types_1.ChainType.SERO})];case 1:return(t=e.sent())&&0<t.length?[4,new ethWallet_1.default(t[0].keystore).exportMnemonic(r)]:[3,3];case 2:return[2,e.sent()];case 3:return[2]}})})},e.prototype.exportKeystore=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.keyStoreCollection.find({accountId:n})];case 1:return(t=e.sent())&&0!=t.length?(t=t[1],[2,JSON.stringify(t.keystore)]):[2,""]}})})},e.prototype.exportPrivateKey=function(n,r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.keyStoreCollection.find({accountId:n,chainType:types_1.ChainType.ETH})];case 1:return(t=e.sent())&&0<t.length?[4,ethereumjs_wallet_1.default.fromV3(t[0].keystore,r)]:[3,3];case 2:return[2,e.sent().getPrivateKeyString()];case 3:return[2]}})})},e.prototype.importPrivateKey=function(y,h,f,_,g){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,s,a,c,i,l,u,d,p;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,13,,14]),[4,(r=ethereumjs_wallet_1.default.fromPrivateKey(utils_1.toBuffer(y))).toV3(h)];case 1:return t=e.sent(),n=JSON.parse(JSON.stringify(t)),o=superzk.seed2Sk(r.getPrivateKey(),1),r=superzk.sk2Tk(o),o=wallet_1.createPkrHash(r,1,1),n.tk=r,n.address=o,s=uuidv4(randomBytes(16)),[4,collection_1.keyStoreCollection.find({address:n.address})];case 2:return a=e.sent(),[4,collection_1.keyStoreCollection.find({address:t.address})];case 3:return(c=e.sent(),(i={})[types_1.ChainType.SERO]=n.address,i[types_1.ChainType.ETH]="0x"+t.address,l={accountId:s,address:n.address,chainType:types_1.ChainType.SERO,keystore:n},u={accountId:s,address:t.address,chainType:types_1.ChainType.ETH,keystore:t},a&&0<a.length)?(d=a[0],s=d.accountId,console.log("sero tmp>",d),d.keystore=l.keystore,[4,collection_1.keyStoreCollection.update(d)]):[3,5];case 4:return e.sent(),[3,7];case 5:return[4,collection_1.keyStoreCollection.insert(l)];case 6:e.sent(),e.label=7;case 7:return c&&0<c.length?(d=c[0],console.log("eth tmp>",d),d.keystore=u.keystore,[4,collection_1.keyStoreCollection.update(d)]):[3,9];case 8:return e.sent(),[3,11];case 9:return[4,collection_1.keyStoreCollection.insert(u)];case 10:e.sent(),e.label=11;case 11:return[4,collection_1.accountCollection.find({accountId:s})];case 12:return(u=e.sent())&&0<u.length?((d=u[0]).name=f,d.passwordHint=_,d.avatar=g,collection_1.accountCollection.update(d).then().catch(function(e){console.log(s)})):collection_1.accountCollection.insert({accountId:s,createType:types_1.CreateType.PrivateKey,name:f,passwordHint:_,avatar:g,addresses:i}).then().catch(function(e){console.log(s)}),[2,new Promise(function(e,t){e(s)})];case 13:return p=e.sent(),console.error(p),[2,new Promise(function(e,t){t(p)})];case 14:return[2]}})})},e.prototype.accounts=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.accountCollection.findAll()];case 1:return[2,e.sent()]}})})},e.prototype.accountInfo=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.accountCollection.find({accountId:n})];case 1:return(t=e.sent())&&0<t.length?[2,t[0]]:[2]}})})},e.prototype.signTx=function(n,r,o,s,a){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.keyStoreCollection.find({accountId:n,chainType:types_1.ChainType.ETH})];case 1:if(!(t=e.sent())||0==t.length)return[2];switch(t=t[0],o){case types_1.ChainType.ETH:return[3,2];case types_1.ChainType.SERO:return[3,4]}return[3,6];case 2:return[4,new ethWallet_1.default(t.keystore).buildSerializedTx(s,r,a)];case 3:return[2,e.sent()];case 4:return[4,new seroWallet_1.SeroWallet(t.keystore).buildSerializedTx(s,r)];case 5:return[2,e.sent()];case 6:return[3,7];case 7:return[2]}})})},e.prototype.importMnemonic=function(y,h,f,_,g){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,s,a,c,i,l,u,d,p;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,14,,15]),t=new seroWallet_1.SeroWallet,[4,(n=new ethWallet_1.default).importMnemonic(y,h)];case 1:return r=e.sent(),[4,t.importMnemonic(y,h)];case 2:return o=e.sent(),s=uuidv4(randomBytes(16)),[4,collection_1.keyStoreCollection.find({address:o.address})];case 3:return a=e.sent(),[4,collection_1.keyStoreCollection.find({address:r.address})];case 4:return(c=e.sent(),console.log(o,n,s,"importMnemonic"),(i={})[types_1.ChainType.SERO]=o.address,i[types_1.ChainType.ETH]="0x"+r.address,l={accountId:s,address:o.address,chainType:types_1.ChainType.SERO,keystore:o},u={accountId:s,address:r.address,chainType:types_1.ChainType.ETH,keystore:r},a&&0<a.length)?(d=a[0],s=d.accountId,console.log("sero tmp>",d),d.keystore=l.keystore,[4,collection_1.keyStoreCollection.update(d)]):[3,6];case 5:return e.sent(),[3,8];case 6:return[4,collection_1.keyStoreCollection.insert(l)];case 7:e.sent(),e.label=8;case 8:return c&&0<c.length?(d=c[0],console.log("eth tmp>",d),d.keystore=u.keystore,[4,collection_1.keyStoreCollection.update(d)]):[3,10];case 9:return e.sent(),[3,12];case 10:return[4,collection_1.keyStoreCollection.insert(u)];case 11:e.sent(),e.label=12;case 12:return[4,collection_1.accountCollection.find({accountId:s})];case 13:return(u=e.sent())&&0<u.length?((d=u[0]).name=f,d.passwordHint=_,d.avatar=g,collection_1.accountCollection.update(d).then().catch(function(e){console.log(s)})):collection_1.accountCollection.insert({accountId:s,name:f,createType:types_1.CreateType.Mnemonic,passwordHint:_,avatar:g,addresses:i}).then().catch(function(e){console.log(s)}),[2,new Promise(function(e,t){e(s)})];case 14:return p=e.sent(),[2,new Promise(function(e,t){t(p)})];case 15:return[2]}})})},e}(),service=new Service;function sendMessage(e){console.log("send msg: ",e),self.postMessage(e)}self.addEventListener("message",function(e){if(e&&e.data&&e.data.method){var t=e.data;switch(t.method){case types_1.Method.exportMnemonic:service.exportMnemonic(t.data.accountId,t.data.password).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.importMnemonic:service.importMnemonic(t.data.mnemonic,t.data.password,t.data.name,t.data.passwordHint,t.data.avatar).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){console.error(e),t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.signTx:console.log("signTx begin.."),service.signTx(t.data.accountId,t.data.password,t.data.chainType,t.data.params,t.data.chainParams).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){console.error(e),t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.generateMnemonic:t.result=service.generateMnemonic(),sendMessage(t);break;case types_1.Method.getAccountInfo:service.accountInfo(t.data.accountId).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.getAccountList:service.accounts().then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.exportKeystore:service.exportKeystore(t.data.accountId).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.exportPrivateKey:service.exportPrivateKey(t.data.accountId,t.data.password).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.importPrivateKey:service.importPrivateKey(t.data.mnemonic,t.data.password,t.data.name,t.data.passwordHint,t.data.avatar).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;default:service.execute(t).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)})}}});