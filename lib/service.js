"use strict";var __awaiter=this&&this.__awaiter||function(e,o,c,i){return new(c=c||Promise)(function(n,t){function r(e){try{s(i.next(e))}catch(e){t(e)}}function a(e){try{s(i.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?n(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(r,a)}s((i=i.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(n,r){var a,s,o,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;c;)try{if(a=1,s&&(o=2&t[0]?s.return:t[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,t[1])).done)return o;switch(s=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,s=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(o=0<(o=c.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){c.label=t[1];break}if(6===t[0]&&c.label<o[1]){c.label=o[1],o=t;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(t);break}o[2]&&c.ops.pop(),c.trys.pop();continue}t=r.call(n,c)}catch(e){t=[6,e],s=0}finally{a=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var seroWallet_1=require("./wallet/seroWallet"),ethWallet_1=require("./wallet/ethWallet"),types_1=require("./types"),collection_1=require("./collection"),superzk=require("jsuperzk/dist/protocol/account"),wallet_1=require("jsuperzk/dist/wallet/wallet"),wallet_2=require("./wallet/wallet"),ethereumjs_wallet_1=require("ethereumjs-wallet"),utils_1=require("jsuperzk/src/utils/utils"),tronWallet_1=require("./wallet/tronWallet"),crypto_1=require("tron-lib/src/utils/crypto"),uuidv4=require("uuid/v4"),randomBytes=require("randombytes"),Service=function(){function e(){var t=this;this.execute=function(e){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(e){return[2]})})}}return e.prototype.generateMnemonic=function(){return(new seroWallet_1.SeroWallet).generateMnemonic()},e.prototype.exportMnemonic=function(n,r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.keyStoreCollection.find({accountId:n,chainType:types_1.ChainType.SERO})];case 1:return(t=e.sent())&&0<t.length?[4,new ethWallet_1.default(t[0].keystore).exportMnemonic(r)]:[3,3];case 2:return[2,e.sent()];case 3:return[2]}})})},e.prototype.exportKeystore=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.keyStoreCollection.find({accountId:n})];case 1:return(t=e.sent())&&0!=t.length?(t=t[1],[2,JSON.stringify(t.keystore)]):[2,""]}})})},e.prototype.exportPrivateKey=function(n,r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.keyStoreCollection.find({accountId:n,chainType:types_1.ChainType.ETH})];case 1:return(t=e.sent())&&0<t.length?[4,ethereumjs_wallet_1.default.fromV3(t[0].keystore,r)]:[3,3];case 2:return[2,e.sent().getPrivateKeyString()];case 3:return[2]}})})},e.prototype.importPrivateKey=function(p,h,_,f,g){return __awaiter(this,void 0,void 0,function(){var t,n,r,a,s,o,c,i,l,u,d,y;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,13,,14]),[4,(r=ethereumjs_wallet_1.default.fromPrivateKey(utils_1.toBuffer(p))).toV3(h)];case 1:return t=e.sent(),n=JSON.parse(JSON.stringify(t)),a=superzk.seed2Sk(r.getPrivateKey(),1),r=superzk.sk2Tk(a),a=wallet_1.createPkrHash(r,1,1),n.tk=r,n.address=a,s=uuidv4(randomBytes(16)),[4,collection_1.keyStoreCollection.find({address:n.address})];case 2:return o=e.sent(),[4,collection_1.keyStoreCollection.find({address:t.address})];case 3:return(c=e.sent(),(i={})[types_1.ChainType.SERO]=n.address,i[types_1.ChainType.ETH]="0x"+t.address,l={accountId:s,address:n.address,chainType:types_1.ChainType.SERO,keystore:n},u={accountId:s,address:t.address,chainType:types_1.ChainType.ETH,keystore:t},o&&0<o.length)?(d=o[0],s=d.accountId,d.keystore=l.keystore,[4,collection_1.keyStoreCollection.update(d)]):[3,5];case 4:return e.sent(),[3,7];case 5:return[4,collection_1.keyStoreCollection.insert(l)];case 6:e.sent(),e.label=7;case 7:return c&&0<c.length?((d=c[0]).keystore=u.keystore,[4,collection_1.keyStoreCollection.update(d)]):[3,9];case 8:return e.sent(),[3,11];case 9:return[4,collection_1.keyStoreCollection.insert(u)];case 10:e.sent(),e.label=11;case 11:return[4,collection_1.accountCollection.find({accountId:s})];case 12:return(u=e.sent())&&0<u.length?((d=u[0]).name=_,d.passwordHint=f,d.avatar=g,collection_1.accountCollection.update(d).then().catch(function(e){})):collection_1.accountCollection.insert({accountId:s,createType:types_1.CreateType.PrivateKey,name:_,passwordHint:f,avatar:g,addresses:i}).then().catch(function(e){console.log(s)}),[2,new Promise(function(e,t){e(s)})];case 13:return y=e.sent(),console.error(y),[2,new Promise(function(e,t){t(y)})];case 14:return[2]}})})},e.prototype.accounts=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.accountCollection.findAll()];case 1:return[2,e.sent()]}})})},e.prototype.accountInfo=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.accountCollection.find({accountId:n})];case 1:return(t=e.sent())&&0<t.length?[2,t[0]]:[2]}})})},e.prototype.signTx=function(r,a,s,o,c){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=s==types_1.ChainType.SERO?types_1.ChainType.ETH:s,[4,collection_1.keyStoreCollection.find({accountId:r,chainType:t})];case 1:if(!(n=e.sent())||0==n.length)return[2,Promise.reject("No keystore find.")];switch(n=n[0],s){case types_1.ChainType.ETH:return[3,2];case types_1.ChainType.SERO:return[3,4];case types_1.ChainType.TRON:return[3,6]}return[3,8];case 2:return[4,new ethWallet_1.default(n.keystore).buildSerializedTx(o,a,c)];case 3:return[2,e.sent()];case 4:return[4,new seroWallet_1.SeroWallet(n.keystore).buildSerializedTx(o,a)];case 5:return[2,e.sent()];case 6:return[4,new tronWallet_1.default(n.keystore).buildSerializedTx(o,a)];case 7:return n=e.sent(),[2,Promise.resolve(n)];case 8:return[3,9];case 9:return[2,Promise.resolve()]}})})},e.prototype.importMnemonic=function(y,p,h,_,f){return __awaiter(this,void 0,void 0,function(){var t,n,r,a,s,o,c,i,l,u,d;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,14,,15]),t=new seroWallet_1.SeroWallet,[4,(new ethWallet_1.default).importMnemonic(y,p)];case 1:return n=e.sent(),[4,t.importMnemonic(y,p)];case 2:return r=e.sent(),a=uuidv4(randomBytes(16)),[4,collection_1.keyStoreCollection.find({address:r.address})];case 3:return s=e.sent(),[4,collection_1.keyStoreCollection.find({address:n.address})];case 4:return(o=e.sent(),(c={})[types_1.ChainType.SERO]=r.address,c[types_1.ChainType.ETH]="0x"+n.address,i={accountId:a,address:r.address,chainType:types_1.ChainType.SERO,keystore:r},l={accountId:a,address:n.address,chainType:types_1.ChainType.ETH,keystore:n},s&&0<s.length)?(u=s[0],a=u.accountId,u.keystore=i.keystore,[4,collection_1.keyStoreCollection.update(u)]):[3,6];case 5:return e.sent(),[3,8];case 6:return[4,collection_1.keyStoreCollection.insert(i)];case 7:e.sent(),e.label=8;case 8:return o&&0<o.length?((u=o[0]).keystore=l.keystore,[4,collection_1.keyStoreCollection.update(u)]):[3,10];case 9:return e.sent(),[3,12];case 10:return[4,collection_1.keyStoreCollection.insert(l)];case 11:e.sent(),e.label=12;case 12:return[4,collection_1.accountCollection.find({accountId:a})];case 13:return(l=e.sent())&&0<l.length?((u=l[0]).name=h,u.passwordHint=_,u.avatar=f,collection_1.accountCollection.update(u).then().catch(function(e){console.log(a)})):collection_1.accountCollection.insert({accountId:a,name:h,createType:types_1.CreateType.Mnemonic,passwordHint:_,avatar:f,addresses:c}).then().catch(function(e){console.log(a)}),[2,new Promise(function(e,t){e(a)})];case 14:return d=e.sent(),[2,new Promise(function(e,t){t(d)})];case 15:return[2]}})})},e.prototype.genNewWallet=function(s,o,c){return __awaiter(this,void 0,void 0,function(){var t,n,r,a;return __generator(this,function(e){switch(e.label){case 0:return[4,collection_1.keyStoreCollection.find({accountId:s,chainType:c})];case 1:return(t=e.sent())&&0<t.length?[2,Promise.reject("Chain:"+types_1.ChainType[c]+" is exist!")]:[4,this.accountInfo(s)];case 2:return(n=e.sent(),a={},n.createType!=types_1.CreateType.PrivateKey)?[3,4]:(r=utils_1.toBuffer(wallet_2.walletEx.getSignKey()),[4,ethereumjs_wallet_1.default.fromPrivateKey(r).toV3(o)]);case 3:return(a=e.sent()).address=crypto_1.getBase58CheckAddress(crypto_1.getAddressFromPriKey(r)),[3,6];case 4:return n.createType!=types_1.CreateType.Mnemonic?[3,6]:[4,(new tronWallet_1.default).importMnemonic(wallet_2.walletEx.getSignKey(),o)];case 5:a=e.sent(),e.label=6;case 6:return c!=types_1.ChainType.TRON?[3,10]:[4,collection_1.accountCollection.find({accountId:s})];case 7:return(r=e.sent())&&0!=r.length?(n=r[0],(r=n.addresses)[c]=a.address,n.addresses=r,[4,collection_1.accountCollection.update(n)]):[2,Promise.reject("No available account")];case 8:return e.sent(),a={accountId:s,address:a.address,chainType:types_1.ChainType.TRON,keystore:a},[4,collection_1.keyStoreCollection.insert(a)];case 9:e.sent(),e.label=10;case 10:return[2]}})})},e.prototype.unlockWallet=function(s,o){return __awaiter(this,void 0,void 0,function(){var t,n,r,a;return __generator(this,function(e){switch(e.label){case 0:return n=types_1.ChainType.ETH,[4,collection_1.keyStoreCollection.find({accountId:s,chainType:n})];case 1:return(t=e.sent())&&0==t.length?[2,Promise.reject("Chain:"+types_1.ChainType[n]+" is not exist!")]:[4,this.accountInfo(s)];case 2:return(r=e.sent()).createType!=types_1.CreateType.PrivateKey?[3,4]:[4,this.exportPrivateKey(s,o)];case 3:return n=e.sent(),wallet_2.walletEx.setSignKey(n),[3,8];case 4:return r.createType!=types_1.CreateType.Mnemonic?[3,8]:[4,collection_1.keyStoreCollection.find({accountId:s,chainType:types_1.ChainType.SERO})];case 5:return r=e.sent(),a="",r&&0<r.length?[4,new ethWallet_1.default(r[0].keystore).exportMnemonic(o)]:[3,7];case 6:a=e.sent(),e.label=7;case 7:wallet_2.walletEx.setSignKey(a),e.label=8;case 8:return[2,Promise.resolve(!0)]}})})},e.prototype.isLocked=function(){return!wallet_2.walletEx.getSignKey()},e}(),service=new Service;function sendMessage(e){console.log("send msg: ",e),self.postMessage(e)}self.addEventListener("message",function(e){if(e&&e.data&&e.data.method){var t=e.data;switch(t.method){case types_1.Method.exportMnemonic:service.exportMnemonic(t.data.accountId,t.data.password).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.importMnemonic:service.importMnemonic(t.data.mnemonic,t.data.password,t.data.name,t.data.passwordHint,t.data.avatar).then(function(e){wallet_2.walletEx.setSignKey(t.data.mnemonic),t.result=e,sendMessage(t)}).catch(function(e){console.error(e),t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.signTx:service.signTx(t.data.accountId,t.data.password,t.data.chainType,t.data.params,t.data.chainParams).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){console.error(e),t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.generateMnemonic:t.result=service.generateMnemonic(),sendMessage(t);break;case types_1.Method.getAccountInfo:service.accountInfo(t.data.accountId).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.getAccountList:service.accounts().then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.exportKeystore:service.exportKeystore(t.data.accountId).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.exportPrivateKey:service.exportPrivateKey(t.data.accountId,t.data.password).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.importPrivateKey:service.importPrivateKey(t.data.mnemonic,t.data.password,t.data.name,t.data.passwordHint,t.data.avatar).then(function(e){wallet_2.walletEx.setSignKey(t.data.mnemonic),t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.genNewWallet:service.genNewWallet(t.data.accountId,t.data.password,t.data.chainType).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){console.error(e),t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.unlockWallet:service.unlockWallet(t.data.accountId,t.data.password).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){console.error(e),t.error="string"==typeof e?e:e.message,sendMessage(t)});break;case types_1.Method.isLocked:t.result=service.isLocked(),sendMessage(t);break;default:service.execute(t).then(function(e){t.result=e,sendMessage(t)}).catch(function(e){t.error="string"==typeof e?e:e.message,sendMessage(t)})}}});