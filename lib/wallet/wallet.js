"use strict";var __awaiter=this&&this.__awaiter||function(e,c,u,a){return new(u=u||Promise)(function(r,t){function n(e){try{i(a.next(e))}catch(e){t(e)}}function o(e){try{i(a.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?r(e.value):((t=e.value)instanceof u?t:new u(function(e){e(t)})).then(n,o)}i((a=a.apply(e,c||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,i,c,u={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;u;)try{if(o=1,i&&(c=2&t[0]?i.return:t[0]?i.throw||((c=i.return)&&c.call(i),0):i.next)&&!(c=c.call(i,t[1])).done)return c;switch(i=0,c&&(t=[2&t[0],c.value]),t[0]){case 0:case 1:c=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,i=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(c=0<(c=u.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3])){u.label=t[1];break}if(6===t[0]&&u.label<c[1]){u.label=c[1],c=t;break}if(c&&u.label<c[2]){u.label=c[2],u.ops.push(t);break}c[2]&&u.ops.pop(),u.trys.pop();continue}t=n.call(r,u)}catch(e){t=[6,e],i=0}finally{o=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.IWallet=exports.walletEx=void 0;var utils_1=require("jsuperzk/dist/utils/utils"),crypto=require("crypto"),collection_1=require("../collection"),crypto_1=require("../utils/crypto"),randomBytes=require("randombytes"),scryptsy=require("scrypt.js"),uuidv4=require("uuid/v4"),keccak256=require("keccak256"),bip39=require("bip39"),CryptoJS=require("crypto-js"),WalletEx=function(){function e(){var e=this;this.getPKey=function(e,t){return CryptoJS.SHA256([e,t].join("")).toString()},this.lock=function(){e.pKey="",e.accountId=""}}return e.prototype.setSignKey=function(n,o,i){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t=this.getPKey(o,i),[4,collection_1.accountCollection.find({accountId:i})];case 1:return(r=e.sent())&&0<r.length?((r=r[0]).key=crypto_1.Encrypt({key:n},t),[4,collection_1.accountCollection.update(r)]):[3,3];case 2:return e.sent(),this.pKey=t,this.accountId=i,[2,Promise.resolve(!0)];case 3:return[2,Promise.reject("account not find!")]}})})},e.prototype.unLock=function(n,o){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t=this.pKey,o&&(t=this.getPKey(o,n)),[4,collection_1.accountCollection.find({accountId:n})];case 1:return(r=e.sent())&&0<r.length?(r=r[0],(r=crypto_1.Decrypt(r.key,t))&&r.key?(this.pKey=t,this.accountId=n,[2,Promise.resolve(r.key)]):[2,Promise.reject("Invalid Password!")]):[2,Promise.reject("account not find!")]}})})},e.prototype.getSignKey=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return this.pKey?[4,this.unLock(this.accountId)]:[2,Promise.reject("wallet is unlock!")];case 1:return[2,e.sent()]}})})},e.prototype.getP=function(){return this.pKey},e}(),walletEx=new WalletEx;exports.walletEx=walletEx;var IWallet=function(){function e(){}return e.prototype.generateMnemonic=function(){return bip39.generateMnemonic()},e.prototype.genKeystore=function(e,t,r){if(!this.keyExists(e))throw new Error("This is a public key only wallet");var n={cipher:"aes-128-ctr",kdf:"scrypt",salt:randomBytes(32),iv:randomBytes(16),uuid:randomBytes(16),dklen:32,c:262144,n:262144,r:8,p:1},o=this.kdfParamsForScrypt(n),i=scryptsy(Buffer.from(t),utils_1.toBuffer(o.salt),o.n,o.r,o.p,o.dklen),t=crypto.createCipheriv(n.cipher,i.slice(0,16),n.iv);if(!t)throw new Error("Unsupported cipher");e=this.runCipherBuffer(t,e),i=keccak256(Buffer.concat([i.slice(16,32),Buffer.from(e)]));return o.salt=o.salt,{version:r,id:uuidv4({random:n.uuid}),address:"",crypto:{ciphertext:e.toString("hex"),cipherparams:{iv:n.iv.toString("hex")},cipher:n.cipher,kdf:n.kdf,kdfparams:o,mac:i.toString("hex")}}},e.prototype.kdfParamsForScrypt=function(e){return{dklen:e.dklen,salt:e.salt.toString("hex"),n:e.n,r:e.r,p:e.p}},e.prototype.keyExists=function(e){return null!=e},e.prototype.decryptKeystore=function(e,t){var r="object"==typeof e?e:JSON.parse(e);if("scrypt"!==r.crypto.kdf)throw new Error("Unsupported key derivation scheme");e=r.crypto.kdfparams,t=scryptsy(Buffer.from(t),utils_1.toBuffer(e.salt),e.n,e.r,e.p,e.dklen);e=Buffer.from(r.crypto.ciphertext,"hex");if(keccak256(Buffer.concat([t.slice(16,32),e])).toString("hex")!==r.crypto.mac)throw new Error("Key derivation failed - possibly wrong passphrase");r=crypto.createDecipheriv(r.crypto.cipher,t.slice(0,16),Buffer.from(r.crypto.cipherparams.iv,"hex"));return this.runCipherBuffer(r,e)},e.prototype.runCipherBuffer=function(e,t){return Buffer.concat([e.update(t),e.final()])},e}();exports.IWallet=IWallet;